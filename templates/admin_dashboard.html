<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Planning Poker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .navbar {
            background: var(--card-background-color);
            border-bottom: 1px solid var(--muted-border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .navbar-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-background-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--muted-border-color);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 2.5rem;
            color: var(--primary);
        }

        .stat-card p {
            margin: 0;
            color: var(--muted-color);
        }

        .section {
            margin-bottom: 3rem;
        }

        .section h2 {
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending { background: #ffd700; color: #000; }
        .status-voting { background: #4a90e2; color: #fff; }
        .status-revealed { background: #ff9800; color: #fff; }
        .status-completed { background: #4caf50; color: #fff; }

        .votes-list {
            font-size: 0.875rem;
            color: var(--muted-color);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--muted-color);
        }

        .filter-controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-controls input,
        .filter-controls select {
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }

            .navbar-actions {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üìä Admin Dashboard</h1>
        <div class="navbar-actions">
            <a href="{{ url_for('export_stories_markdown') }}" role="button" class="secondary" download>
                üì• Stories exportieren (.md)
            </a>
            <a href="{{ url_for('index') }}" role="button" class="secondary">Zur App</a>
            <form method="POST" action="{{ url_for('admin_logout') }}" style="margin: 0;">
                <button type="submit" class="contrast">Logout</button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <!-- CSV Import Section -->
        <section class="section">
            <h2>üì¶ Archive Stories Importieren</h2>
            <p>Importiere historische Stories aus einer CSV-Datei, um sie als Trainingsdaten f√ºr KI-Sch√§tzungen zu nutzen.</p>

            <details>
                <summary>CSV-Format anzeigen</summary>
                <p>Die CSV-Datei muss folgende Spalten enthalten:</p>
                <pre><code>jira_key,title,description,story_points
SEC-962,Story Titel,Beschreibung...,13
VK-123,Weiterer Titel,Weitere Beschreibung...,5</code></pre>
                <p><strong>Hinweise:</strong></p>
                <ul>
                    <li><code>jira_key</code> ist optional (kann leer sein)</li>
                    <li><code>story_points</code> ist optional (kann leer sein)</li>
                    <li><code>title</code> ist Pflicht</li>
                    <li><code>description</code> wird empfohlen f√ºr bessere KI-Sch√§tzungen</li>
                </ul>
            </details>

            <form id="csv-upload-form" enctype="multipart/form-data" style="margin-top: 1rem;">
                <input type="file" id="csv-file-input" name="csv_file" accept=".csv" required>
                <button type="submit" id="import-btn">üì• CSV importieren</button>
            </form>

            <div id="import-result" style="margin-top: 1rem; display: none;"></div>
        </section>

        <!-- AI Embeddings Section -->
        <section class="section">
            <h2>ü§ñ KI Embeddings</h2>
            <p>Verwalte Embeddings f√ºr semantische Suche und KI-Sch√§tzungen.</p>

            <div id="embedding-status" style="margin-top: 1rem;">
                <p>‚è≥ Lade Status...</p>
            </div>

            <button id="generate-embeddings-btn" style="margin-top: 1rem;" disabled>
                ‚öôÔ∏è Fehlende Embeddings generieren
            </button>

            <div id="embedding-result" style="margin-top: 1rem; display: none;"></div>
        </section>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>{{ total_stories }}</h3>
                <p>Gesamt Stories</p>
            </div>
            <div class="stat-card">
                <h3>{{ total_users }}</h3>
                <p>Gesamt Teilnehmer</p>
            </div>
            <div class="stat-card">
                <h3>{{ stories | selectattr('status', 'equalto', 'completed') | list | length }}</h3>
                <p>Abgeschlossen</p>
            </div>
        </div>

        <!-- Story Historie -->
        <section class="section">
            <h2>üìù Story Historie</h2>

            {% if stories %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Titel</th>
                            <th>Ersteller</th>
                            <th>Status</th>
                            <th>Runde</th>
                            <th>Punkte</th>
                            <th>Teilnehmer</th>
                            <th>Kommentare</th>
                            <th>Erstellt</th>
                            <th>Abgeschlossen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for story in stories %}
                        <tr>
                            <td>{{ story.id }}</td>
                            <td>
                                <strong>{{ story.title }}</strong>
                                {% if story.description %}
                                <br><small>{{ story.description[:50] }}{% if story.description|length > 50 %}...{% endif %}</small>
                                {% endif %}
                            </td>
                            <td>{{ story.creator_name }}</td>
                            <td>
                                <span class="status-badge status-{{ story.status }}">
                                    {{ story.status }}
                                </span>
                            </td>
                            <td>{{ story.round }}</td>
                            <td>
                                {% if story.final_points is not none %}
                                    <strong>{{ story.final_points }}</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if story.all_votes %}
                                <div class="votes-list">
                                    {% set votes_by_round = {} %}
                                    {% for vote in story.all_votes %}
                                        {% set round_num = vote.round %}
                                        {% if round_num not in votes_by_round %}
                                            {% set _ = votes_by_round.update({round_num: []}) %}
                                        {% endif %}
                                        {% set _ = votes_by_round[round_num].append(vote) %}
                                    {% endfor %}

                                    {% for round_num in votes_by_round.keys()|sort %}
                                        <div style="margin-bottom: 0.3rem;">
                                            <strong style="color: var(--muted-color);">R{{ round_num }}:</strong>
                                            {% for vote in votes_by_round[round_num] %}
                                                {{ vote.name }}:{{ vote.points }}{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if story.status == 'completed' %}
                                    <a href="/story/{{ story.id }}" target="_blank">
                                        üí¨ {{ story.comment_count if story.comment_count else 0 }}
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ story.created_at }}</small>
                            </td>
                            <td>
                                {% if story.completed_at %}
                                    <small>{{ story.completed_at }}</small>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>Noch keine Stories vorhanden.</p>
            </div>
            {% endif %}
        </section>

        <!-- User Aktivit√§t -->
        <section class="section">
            <h2>üë• User Aktivit√§t</h2>

            {% if users %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Erstes Login</th>
                            <th>Letztes Login</th>
                            <th>Anzahl Votes</th>
                            <th>Letzter Vote</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td><strong>{{ user.name }}</strong></td>
                            <td><small>{{ user.first_seen }}</small></td>
                            <td><small>{{ user.last_seen }}</small></td>
                            <td>{{ user.vote_count }}</td>
                            <td>
                                {% if user.last_vote %}
                                    <small>{{ user.last_vote }}</small>
                                {% else %}
                                    <small>-</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>Noch keine User vorhanden.</p>
            </div>
            {% endif %}
        </section>
    </main>

    <script>
        // CSV Upload Handler
        document.getElementById('csv-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('csv-file-input');
            const importBtn = document.getElementById('import-btn');
            const resultDiv = document.getElementById('import-result');

            if (!fileInput.files.length) {
                alert('Bitte w√§hle eine CSV-Datei aus.');
                return;
            }

            // Show loading state
            importBtn.disabled = true;
            importBtn.textContent = '‚è≥ Importiere...';
            resultDiv.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('csv_file', fileInput.files[0]);

                const response = await fetch('/admin/import/archive-stories', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.error) {
                    resultDiv.innerHTML = `<article style="background: #ff4444; color: white;"><strong>‚ùå Fehler:</strong> ${result.error}</article>`;
                } else {
                    let message = `<article style="background: #4caf50; color: white;">
                        <strong>‚úÖ Import erfolgreich!</strong><br>
                        Importiert: ${result.imported} Stories<br>
                        √úbersprungen: ${result.skipped} Stories
                    </article>`;

                    if (result.errors && result.errors.length > 0) {
                        message += `<article style="background: #ff9800; color: white; margin-top: 0.5rem;">
                            <strong>‚ö†Ô∏è Warnungen:</strong><br>
                            ${result.errors.join('<br>')}
                        </article>`;
                    }

                    resultDiv.innerHTML = message;

                    // Reset form
                    fileInput.value = '';

                    // Reload page after 3 seconds to show updated stats
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }

                resultDiv.style.display = 'block';

            } catch (error) {
                resultDiv.innerHTML = `<article style="background: #ff4444; color: white;"><strong>‚ùå Fehler:</strong> ${error.message}</article>`;
                resultDiv.style.display = 'block';
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = 'üì• CSV importieren';
            }
        });

        // ============================================================================
        // AI Embeddings Handler
        // ============================================================================

        // Load embedding status on page load
        async function loadEmbeddingStatus() {
            const statusDiv = document.getElementById('embedding-status');
            const generateBtn = document.getElementById('generate-embeddings-btn');

            try {
                const response = await fetch('/admin/embedding-status');
                const data = await response.json();

                if (data.error) {
                    statusDiv.innerHTML = `<article style="background: #ff4444; color: white;">‚ùå Fehler: ${data.error}</article>`;
                    return;
                }

                const { total_completed, stories_with_embeddings, stories_without_embeddings } = data;

                let statusHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                statusHTML += `<div style="background: var(--card-background-color); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--muted-border-color);">
                    <h4 style="margin: 0; color: var(--primary);">${total_completed}</h4>
                    <p style="margin: 0; font-size: 0.875rem;">Abgeschlossene Stories</p>
                </div>`;
                statusHTML += `<div style="background: var(--card-background-color); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--muted-border-color);">
                    <h4 style="margin: 0; color: #4caf50;">${stories_with_embeddings}</h4>
                    <p style="margin: 0; font-size: 0.875rem;">Mit Embeddings</p>
                </div>`;
                statusHTML += `<div style="background: var(--card-background-color); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--muted-border-color);">
                    <h4 style="margin: 0; color: ${stories_without_embeddings > 0 ? '#ff9800' : '#4caf50'};">${stories_without_embeddings}</h4>
                    <p style="margin: 0; font-size: 0.875rem;">Ohne Embeddings</p>
                </div>`;
                statusHTML += '</div>';

                if (stories_without_embeddings > 0) {
                    statusHTML += `<p style="margin-top: 1rem; color: var(--muted-color);">
                        <strong>Hinweis:</strong> ${stories_without_embeddings} Stories ben√∂tigen noch Embeddings f√ºr KI-Sch√§tzungen.
                    </p>`;
                }

                statusDiv.innerHTML = statusHTML;

                // Enable button if there are stories without embeddings
                generateBtn.disabled = stories_without_embeddings === 0;
                if (stories_without_embeddings === 0) {
                    generateBtn.textContent = '‚úÖ Alle Stories haben Embeddings';
                }

            } catch (error) {
                statusDiv.innerHTML = `<article style="background: #ff4444; color: white;">‚ùå Fehler beim Laden: ${error.message}</article>`;
            }
        }

        // Generate embeddings
        document.getElementById('generate-embeddings-btn').addEventListener('click', async () => {
            const generateBtn = document.getElementById('generate-embeddings-btn');
            const resultDiv = document.getElementById('embedding-result');

            if (!confirm('Embeddings f√ºr alle fehlenden Stories generieren? Dies kann einige Minuten dauern.')) {
                return;
            }

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generiere Embeddings...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/admin/generate-embeddings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: 'sentence_transformers',
                        strategy: 'story'
                    })
                });

                const result = await response.json();

                if (result.error) {
                    resultDiv.innerHTML = `<article style="background: #ff4444; color: white;"><strong>‚ùå Fehler:</strong> ${result.error}</article>`;
                } else {
                    let message = `<article style="background: #4caf50; color: white;">
                        <strong>‚úÖ Embeddings generiert!</strong><br>
                        Verarbeitet: ${result.processed} Stories<br>
                        Fehler: ${result.errors}
                    </article>`;

                    if (result.error_messages && result.error_messages.length > 0) {
                        message += `<article style="background: #ff9800; color: white; margin-top: 0.5rem;">
                            <strong>‚ö†Ô∏è Fehler:</strong><br>
                            ${result.error_messages.join('<br>')}
                        </article>`;
                    }

                    resultDiv.innerHTML = message;

                    // Reload status after 2 seconds
                    setTimeout(() => {
                        loadEmbeddingStatus();
                        resultDiv.style.display = 'none';
                    }, 3000);
                }

                resultDiv.style.display = 'block';

            } catch (error) {
                resultDiv.innerHTML = `<article style="background: #ff4444; color: white;"><strong>‚ùå Fehler:</strong> ${error.message}</article>`;
                resultDiv.style.display = 'block';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚öôÔ∏è Fehlende Embeddings generieren';
            }
        });

        // Load status on page load
        loadEmbeddingStatus();
    </script>
</body>
</html>
